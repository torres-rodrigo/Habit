<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Tracker.ViewModels"
             xmlns:models="clr-namespace:Tracker.Models"
             xmlns:views="clr-namespace:Tracker.Views"
             x:Class="Tracker.Views.TasksPage"
             x:DataType="viewmodels:TaskViewModel"
             Shell.NavBarIsVisible="False">

    <Grid>
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- All Filters in One Line -->
                <HorizontalStackLayout Spacing="10" HorizontalOptions="Start">
                    <Label Text="Filter"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Picker ItemsSource="{Binding DateTypeFilterOptions}"
                            SelectedItem="{Binding SelectedDateTypeFilter}"
                            ItemDisplayBinding="{Binding DisplayName}"
                            WidthRequest="120"/>

                    <Label Text="by"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Picker ItemsSource="{Binding DatePeriodFilterOptions}"
                            SelectedItem="{Binding SelectedDatePeriodFilter}"
                            ItemDisplayBinding="{Binding DisplayName}"
                            IsEnabled="{Binding IsDatePeriodFilterEnabled}"
                            WidthRequest="140"/>

                    <Label Text="Priority âš¡"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Picker ItemsSource="{Binding PriorityFilterOptions}"
                            SelectedItem="{Binding SelectedPriorityFilter}"
                            ItemDisplayBinding="{Binding DisplayName}"
                            WidthRequest="120"/>

                    <!-- Custom Date Display -->
                    <Label Text="{Binding CustomDateDisplayText}"
                           VerticalOptions="Center"
                           FontSize="14"
                           TextColor="{StaticResource Primary}"
                           FontAttributes="Bold"
                           IsVisible="{Binding CustomDateDisplayText, Converter={StaticResource StringToBoolConverter}}">
                        <Label.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnCustomDateTextTapped"/>
                        </Label.GestureRecognizers>
                    </Label>

                    <!-- Due Date Toggle -->
                    <Label Text="Sort by Due Date"
                           VerticalOptions="Center"
                           FontSize="14"
                           Margin="20,0,0,0"/>
                    <Switch IsToggled="{Binding SortByDueDate}"
                            VerticalOptions="Center"/>
                </HorizontalStackLayout>

                <!-- TODO Section -->
                <VerticalStackLayout Spacing="10">
                    <Label Text="TODO" 
                           FontSize="22" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}"/>

                    <CollectionView ItemsSource="{Binding PendingTasks}" SelectionMode="None">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="5"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:TodoTask">
                                <Frame CornerRadius="15"
                                       BorderColor="{StaticResource Primary}"
                                       HasShadow="True"
                                       Margin="0,0,0,5"
                                       Padding="15">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TaskViewModel}}, Path=EditTaskCommand}"
                                                            CommandParameter="{Binding Id}"/>
                                    </Frame.GestureRecognizers>
                                    
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                        <!-- Task Content -->
                                        <VerticalStackLayout Grid.Column="0" Spacing="5">
                                            <HorizontalStackLayout Spacing="8">
                                                <!-- Square Checkbox -->
                                                <Frame CornerRadius="5"
                                                       WidthRequest="20"
                                                       HeightRequest="20"
                                                       Padding="0"
                                                       BorderColor="{StaticResource Primary}"
                                                       BackgroundColor="White"
                                                       HasShadow="False"
                                                       VerticalOptions="Center">
                                                    <Frame.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TaskViewModel}}, Path=ToggleTaskCompletionCommand}"
                                                                            CommandParameter="{Binding Id}"/>
                                                    </Frame.GestureRecognizers>
                                                </Frame>
                                                
                                                <!-- Priority Icon -->
                                                <Grid WidthRequest="12" HeightRequest="12" VerticalOptions="Center"
                                                      IsVisible="{Binding Priority, Converter={StaticResource PriorityToVisibilityConverter}}">
                                                    <!-- Circle for Low -->
                                                    <Ellipse Fill="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                                             WidthRequest="12"
                                                             HeightRequest="12"
                                                             IsVisible="{Binding Priority, Converter={StaticResource PriorityToShapeConverter}, ConverterParameter=Circle}"/>
                                                    
                                                    <!-- Hexagon for Medium -->
                                                    <Polygon Points="6,0 12,3 12,9 6,12 0,9 0,3"
                                                             Fill="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                                             IsVisible="{Binding Priority, Converter={StaticResource PriorityToShapeConverter}, ConverterParameter=Hexagon}"/>
                                                    
                                                    <!-- Inverted Triangle for High -->
                                                    <Polygon Points="6,12 0,0 12,0"
                                                             Fill="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                                             IsVisible="{Binding Priority, Converter={StaticResource PriorityToShapeConverter}, ConverterParameter=Triangle}"/>
                                                </Grid>
                                                
                                                <Label Text="{Binding Name}" 
                                                       FontSize="16" 
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"/>
                                            </HorizontalStackLayout>
                                            <Label Text="{Binding Description}" 
                                                   FontSize="14"
                                                   TextColor="{StaticResource Gray600}"
                                                   MaxLines="5"
                                                   LineBreakMode="TailTruncation"
                                                   IsVisible="{Binding Description, Converter={StaticResource StringNullOrEmptyConverter}}"/>
                                            <Label Text="{Binding DueDate, StringFormat='Due: {0:MMM dd, yyyy}'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource Tertiary}"
                                                   IsVisible="{Binding DueDate, Converter={StaticResource NullToBoolConverter}}"/>
                                            
                                            <!-- Subtasks -->
                                            <VerticalStackLayout Spacing="5"
                                                               IsVisible="{Binding SubTasks.Count, Converter={StaticResource CountToBoolConverter}}">
                                                <CollectionView ItemsSource="{Binding SubTasks}" SelectionMode="None">
                                                    <CollectionView.ItemTemplate>
                                                        <DataTemplate x:DataType="models:SubTask">
                                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="3" Margin="0,1">
                                                                <CheckBox Grid.Column="0"
                                                                        IsChecked="{Binding IsCompleted, Mode=OneWay}"
                                                                        Color="{StaticResource Primary}"
                                                                        CheckedChanged="OnSubTaskCheckChanged"/>
                                                                <Label Grid.Column="1"
                                                                     Text="{Binding Name}"
                                                                     FontSize="13"
                                                                     TextColor="{StaticResource Gray600}"
                                                                     VerticalOptions="Center"
                                                                     TextDecorations="{Binding IsCompleted, Converter={StaticResource BoolToTextDecorationConverter}}"/>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </CollectionView.ItemTemplate>
                                                </CollectionView>
                                                
                                                <!-- Subtask Progress -->
                                                <Label FontSize="12"
                                                       TextColor="{StaticResource Gray500}"
                                                       Margin="0,5,0,0">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="{Binding CompletedSubTasksCount}"/>
                                                            <Span Text="/"/>
                                                            <Span Text="{Binding TotalSubTasksCount}"/>
                                                            <Span Text=" ("/>
                                                            <Span Text="{Binding SubTaskCompletionPercentage}"/>
                                                            <Span Text="%)"/>
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>

                                        <!-- Arrow Icon -->
                                        <Label Grid.Column="1" 
                                               Text="â€º" 
                                               FontSize="24"
                                               TextColor="{StaticResource Gray400}"
                                               VerticalOptions="Center"/>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Completed Section -->
                <VerticalStackLayout Spacing="10">
                    <Label Text="Completed" 
                           FontSize="22" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource Secondary}"/>

                    <CollectionView ItemsSource="{Binding CompletedTasks}" SelectionMode="None">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="5"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:TodoTask">
                                <Frame CornerRadius="10"
                                       BorderColor="{StaticResource Gray300}"
                                       HasShadow="True"
                                       Margin="0,0,0,5"
                                       Padding="15"
                                       BackgroundColor="{StaticResource Gray100}">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TaskViewModel}}, Path=EditTaskCommand}"
                                                            CommandParameter="{Binding Id}"/>
                                    </Frame.GestureRecognizers>
                                    
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                        <!-- Checkbox -->
                                        <Frame Grid.Column="0"
                                               CornerRadius="15"
                                               WidthRequest="30"
                                               HeightRequest="30"
                                               Padding="0"
                                               BorderColor="{StaticResource Secondary}"
                                               BackgroundColor="{StaticResource Secondary}"
                                               HasShadow="False">
                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TaskViewModel}}, Path=ToggleTaskCompletionCommand}"
                                                                    CommandParameter="{Binding Id}"/>
                                            </Frame.GestureRecognizers>
                                            <Label Text="âœ“" 
                                                   FontSize="16"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"/>
                                        </Frame>

                                        <!-- Task Content -->
                                        <VerticalStackLayout Grid.Column="1" Spacing="5">
                                            <HorizontalStackLayout Spacing="8">
                                                <!-- Priority Icon -->
                                                <Grid WidthRequest="12" HeightRequest="12" VerticalOptions="Center"
                                                      IsVisible="{Binding Priority, Converter={StaticResource PriorityToVisibilityConverter}}">
                                                    <!-- Circle for Low -->
                                                    <Ellipse Fill="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                                             WidthRequest="12"
                                                             HeightRequest="12"
                                                             IsVisible="{Binding Priority, Converter={StaticResource PriorityToShapeConverter}, ConverterParameter=Circle}"/>
                                                    
                                                    <!-- Hexagon for Medium -->
                                                    <Polygon Points="6,0 12,3 12,9 6,12 0,9 0,3"
                                                             Fill="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                                             IsVisible="{Binding Priority, Converter={StaticResource PriorityToShapeConverter}, ConverterParameter=Hexagon}"/>
                                                    
                                                    <!-- Inverted Triangle for High -->
                                                    <Polygon Points="6,12 0,0 12,0"
                                                             Fill="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                                             IsVisible="{Binding Priority, Converter={StaticResource PriorityToShapeConverter}, ConverterParameter=Triangle}"/>
                                                </Grid>
                                                
                                                <Label Text="{Binding Name}" 
                                                       FontSize="16" 
                                                       FontAttributes="Bold"
                                                       TextDecorations="Strikethrough"
                                                       TextColor="{StaticResource Gray600}"
                                                       VerticalOptions="Center"/>
                                            </HorizontalStackLayout>
                                            <Label Text="{Binding CompletedDate, StringFormat='Completed: {0:MMM dd, yyyy}'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource Gray500}"/>
                                            
                                            <!-- Subtasks for Completed Tasks -->
                                            <VerticalStackLayout Spacing="5"
                                                               IsVisible="{Binding SubTasks.Count, Converter={StaticResource CountToBoolConverter}}"
                                                               Margin="0,5,0,0">
                                                <CollectionView ItemsSource="{Binding SubTasks}" SelectionMode="None">
                                                    <CollectionView.ItemTemplate>
                                                        <DataTemplate x:DataType="models:SubTask">
                                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="3" Margin="0,1">
                                                                <CheckBox Grid.Column="0"
                                                                        IsChecked="{Binding IsCompleted, Mode=OneWay}"
                                                                        Color="{StaticResource Secondary}"
                                                                        IsEnabled="False"/>
                                                                <Label Grid.Column="1"
                                                                     Text="{Binding Name}"
                                                                     FontSize="13"
                                                                     TextColor="{StaticResource Gray500}"
                                                                     VerticalOptions="Center"
                                                                     TextDecorations="{Binding IsCompleted, Converter={StaticResource BoolToTextDecorationConverter}}"/>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </CollectionView.ItemTemplate>
                                                </CollectionView>
                                                
                                                <!-- Subtask Progress -->
                                                <Label FontSize="12"
                                                       TextColor="{StaticResource Gray500}">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="{Binding CompletedSubTasksCount}"/>
                                                            <Span Text="/"/>
                                                            <Span Text="{Binding TotalSubTasksCount}"/>
                                                            <Span Text=" ("/>
                                                            <Span Text="{Binding SubTaskCompletionPercentage}"/>
                                                            <Span Text="%)"/>
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Floating Action Button -->
        <Button Text="+"
                FontSize="30"
                WidthRequest="60"
                HeightRequest="60"
                CornerRadius="30"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="0,0,20,20"
                Command="{Binding AddTaskCommand}"/>

        <!-- Popup Overlay -->
        <Grid IsVisible="{Binding ShowOverlay}"
              BackgroundColor="Transparent">
            <!-- Background overlay -->
            <BoxView BackgroundColor="#40000000"
                     HorizontalOptions="Fill"
                     VerticalOptions="Fill">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding CloseOverlayCommand}"/>
                </BoxView.GestureRecognizers>
            </BoxView>
            
            <!-- Modal popup container -->
            <Border WidthRequest="400"
                    HeightRequest="380"
                    BackgroundColor="White"
                    StrokeThickness="0"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    Shadow="{Shadow Brush=Black, Opacity=0.3, Radius=20, Offset='0,10'}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer/>
                </Border.GestureRecognizers>
                
                <Grid RowDefinitions="Auto,*,Auto" Padding="0">
                    <!-- Header -->
                    <Grid Grid.Row="0" Padding="24,20">
                        <Label Text="Create New" 
                               FontSize="22" 
                               FontAttributes="Bold"
                               TextColor="#212121"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
                    </Grid>
                    
                    <!-- Options -->
                    <VerticalStackLayout Grid.Row="1" Spacing="12" Padding="20,0" VerticalOptions="Center">
                        <Border BackgroundColor="#F8F9FA"
                                Stroke="#E0E0E0"
                                StrokeThickness="1"
                                Padding="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Grid ColumnDefinitions="60,*,40" Padding="20,20">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding NavigateToHabitCommand}"/>
                                </Grid.GestureRecognizers>
                                
                                <Frame Grid.Column="0" 
                                       WidthRequest="48" 
                                       HeightRequest="48" 
                                       CornerRadius="24" 
                                       BackgroundColor="#6366F1" 
                                       Padding="0"
                                       HasShadow="False">
                                    <Label Text="ðŸŽ¯" 
                                           FontSize="26" 
                                           HorizontalOptions="Center" 
                                           VerticalOptions="Center"/>
                                </Frame>
                                
                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Margin="12,0,0,0">
                                    <Label Text="New Habit" 
                                           FontSize="17" 
                                           FontAttributes="Bold"
                                           TextColor="#212121"/>
                                    <Label Text="Track recurring activities" 
                                           FontSize="13" 
                                           TextColor="#757575"
                                           Margin="0,2,0,0"/>
                                </VerticalStackLayout>
                                
                                <Label Grid.Column="2" 
                                       Text="â€º" 
                                       FontSize="28" 
                                       TextColor="#BDBDBD"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </Border>
                        <Border BackgroundColor="#F8F9FA"
                                Stroke="#E0E0E0"
                                StrokeThickness="1"
                                Padding="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Grid ColumnDefinitions="60,*,40" Padding="20,20">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding NavigateToTaskCommand}"/>
                                </Grid.GestureRecognizers>
                                
                                <Frame Grid.Column="0" 
                                       WidthRequest="48" 
                                       HeightRequest="48" 
                                       CornerRadius="24" 
                                       BackgroundColor="#10B981" 
                                       Padding="0"
                                       HasShadow="False">
                                    <Label Text="âœ“" 
                                           FontSize="26" 
                                           HorizontalOptions="Center" 
                                           VerticalOptions="Center"/>
                                </Frame>
                                
                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Margin="12,0,0,0">
                                    <Label Text="New Task" 
                                           FontSize="17" 
                                           FontAttributes="Bold"
                                           TextColor="#212121"/>
                                    <Label Text="One-time to-do items" 
                                           FontSize="13" 
                                           TextColor="#757575"
                                           Margin="0,2,0,0"/>
                                </VerticalStackLayout>
                                
                                <Label Grid.Column="2" 
                                       Text="â€º" 
                                       FontSize="28" 
                                       TextColor="#BDBDBD"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </Border>
                    </VerticalStackLayout>
                    
                    <!-- Cancel button at bottom -->
                    <Border Grid.Row="2"
                            Stroke="#E0E0E0"
                            StrokeThickness="1"
                            BackgroundColor="#F5F5F5"
                            Margin="20,0,20,16"
                            Padding="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8"/>
                        </Border.StrokeShape>
                        <Button Text="Cancel"
                                Command="{Binding CloseOverlayCommand}"
                                BackgroundColor="Transparent"
                                TextColor="#757575"
                                FontSize="16"
                                FontAttributes="Bold"
                                Padding="12"/>
                    </Border>
                </Grid>
            </Border>
        </Grid>

        <!-- Custom Date Popup -->
        <views:CustomDatePopup x:Name="CustomDatePopupControl"
                               IsVisible="False"/>
    </Grid>
</ContentPage>

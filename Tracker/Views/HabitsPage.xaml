<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Tracker.ViewModels"
             xmlns:controls="clr-namespace:Tracker.Controls"
             x:Class="Tracker.Views.HabitsPage"
             x:DataType="viewmodels:HabitViewModel"
             Shell.NavBarIsVisible="False">

    <Grid>
        <!-- Main Content -->
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="15">
                <CollectionView ItemsSource="{Binding Habits}" SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="5"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:HabitCardViewModel">
                            <Frame CornerRadius="15"
                                   BorderColor="{StaticResource Primary}"
                                   HasShadow="True"
                                   Margin="0,0,0,5"
                                   Padding="15">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HabitViewModel}}, Path=EditHabitCommand}"
                                                        CommandParameter="{Binding Id}"/>
                                </Frame.GestureRecognizers>

                                <VerticalStackLayout Spacing="12">
                                    <Label Text="{Binding Name}" 
                                           FontSize="20" 
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Primary}"/>

                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <Label Grid.Column="0"
                                               FontSize="14" 
                                               TextColor="{StaticResource Gray600}">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="Week " />
                                                    <Span Text="{Binding WeekNumber}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        <HorizontalStackLayout Grid.Column="2" 
                                                              Spacing="8" 
                                                              HorizontalOptions="End"
                                                              Margin="0,0,10,0">
                                            <!-- Circular Progress Indicator -->
                                            <controls:CircularProgressView 
                                                Progress="{Binding WeeklyCompletionDecimal}"
                                                ProgressColor="Green"
                                                TrackColor="{StaticResource Gray300}"
                                                StrokeWidth="3"
                                                WidthRequest="34"
                                                HeightRequest="34"
                                                VerticalOptions="Center"/>
                                            <Label Text="{Binding WeeklyCompletionPercentage}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="Green"
                                                   VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                    </Grid>

                                    <!-- Week Progress -->
                                    <CollectionView ItemsSource="{Binding WeekDays}" 
                                                  SelectionMode="None">
                                        <CollectionView.ItemsLayout>
                                            <GridItemsLayout Orientation="Horizontal" Span="1" />
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="viewmodels:DayCompletionViewModel">
                                                <VerticalStackLayout Spacing="5" Margin="0,0,5,0">
                                                    <Grid HeightRequest="25" HorizontalOptions="Center">
                                                        <!-- Green dot indicator for today -->
                                                        <Ellipse Fill="Green"
                                                                 WidthRequest="10"
                                                                 HeightRequest="10"
                                                                 HorizontalOptions="Center"
                                                                 VerticalOptions="Start"
                                                                 IsVisible="{Binding IsToday}"/>
                                                        <Label Text="{Binding DayName}"
                                                               FontSize="12"
                                                               HorizontalOptions="Center"
                                                               VerticalOptions="End"
                                                               TextColor="{StaticResource Gray600}"/>
                                                    </Grid>
                                                    <Frame CornerRadius="20"
                                                           WidthRequest="40"
                                                           HeightRequest="40"
                                                           Padding="0"
                                                           BorderColor="{Binding ShouldTrack, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Primary|Gray300'}"
                                                           BackgroundColor="{Binding IsCompleted, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Primary|White'}"
                                                           Opacity="{Binding ShouldTrack, Converter={StaticResource BoolToOpacityConverter}}"
                                                           HasShadow="False">
                                                        <Frame.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HabitViewModel}}, Path=ToggleCompletionCommand}"
                                                                                CommandParameter="{Binding .}"/>
                                                        </Frame.GestureRecognizers>
                                                        <Label Text="âœ“" 
                                                               IsVisible="{Binding IsCompleted}"
                                                               FontSize="20"
                                                               TextColor="White"
                                                               HorizontalOptions="Center"
                                                               VerticalOptions="Center"/>
                                                    </Frame>
                                                </VerticalStackLayout>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Floating Action Button -->
        <Button Text="+"
                FontSize="30"
                WidthRequest="60"
                HeightRequest="60"
                CornerRadius="30"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="0,0,20,20"
                Command="{Binding AddHabitCommand}"/>

        <!-- Popup Overlay -->
        <Grid IsVisible="{Binding ShowOverlay}"
              BackgroundColor="Transparent">
            <!-- Background overlay -->
            <BoxView BackgroundColor="#40000000"
                     HorizontalOptions="Fill"
                     VerticalOptions="Fill">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding CloseOverlayCommand}"/>
                </BoxView.GestureRecognizers>
            </BoxView>
            
            <!-- Modal popup container -->
            <Border WidthRequest="400"
                    HeightRequest="380"
                    BackgroundColor="White"
                    StrokeThickness="0"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    Shadow="{Shadow Brush=Black, Opacity=0.3, Radius=20, Offset='0,10'}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer/>
                </Border.GestureRecognizers>
                
                <Grid RowDefinitions="Auto,*,Auto" Padding="0">
                    <!-- Header -->
                    <Grid Grid.Row="0" Padding="24,20">
                        <Label Text="Create New" 
                               FontSize="22" 
                               FontAttributes="Bold"
                               TextColor="#212121"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
                    </Grid>
                    
                    <!-- Options -->
                    <VerticalStackLayout Grid.Row="1" Spacing="12" Padding="20,0" VerticalOptions="Center">
                        <Border BackgroundColor="#F8F9FA"
                                Stroke="#E0E0E0"
                                StrokeThickness="1"
                                Padding="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Grid ColumnDefinitions="60,*,40" Padding="20,20">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding NavigateToHabitCommand}"/>
                                </Grid.GestureRecognizers>
                                
                                <Frame Grid.Column="0" 
                                       WidthRequest="48" 
                                       HeightRequest="48" 
                                       CornerRadius="24" 
                                       BackgroundColor="#6366F1" 
                                       Padding="0"
                                       HasShadow="False">
                                    <Label Text="ðŸŽ¯" 
                                           FontSize="26" 
                                           HorizontalOptions="Center" 
                                           VerticalOptions="Center"/>
                                </Frame>
                                
                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Margin="12,0,0,0">
                                    <Label Text="New Habit" 
                                           FontSize="17" 
                                           FontAttributes="Bold"
                                           TextColor="#212121"/>
                                    <Label Text="Track recurring activities" 
                                           FontSize="13" 
                                           TextColor="#757575"
                                           Margin="0,2,0,0"/>
                                </VerticalStackLayout>
                                
                                <Label Grid.Column="2" 
                                       Text="â€º" 
                                       FontSize="28" 
                                       TextColor="#BDBDBD"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </Border>
                        <Border BackgroundColor="#F8F9FA"
                                Stroke="#E0E0E0"
                                StrokeThickness="1"
                                Padding="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Grid ColumnDefinitions="60,*,40" Padding="20,20">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding NavigateToTaskCommand}"/>
                                </Grid.GestureRecognizers>
                                
                                <Frame Grid.Column="0" 
                                       WidthRequest="48" 
                                       HeightRequest="48" 
                                       CornerRadius="24" 
                                       BackgroundColor="#10B981" 
                                       Padding="0"
                                       HasShadow="False">
                                    <Label Text="âœ“" 
                                           FontSize="26" 
                                           HorizontalOptions="Center" 
                                           VerticalOptions="Center"/>
                                </Frame>
                                
                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Margin="12,0,0,0">
                                    <Label Text="New Task" 
                                           FontSize="17" 
                                           FontAttributes="Bold"
                                           TextColor="#212121"/>
                                    <Label Text="One-time to-do items" 
                                           FontSize="13" 
                                           TextColor="#757575"
                                           Margin="0,2,0,0"/>
                                </VerticalStackLayout>
                                
                                <Label Grid.Column="2" 
                                       Text="â€º" 
                                       FontSize="28" 
                                       TextColor="#BDBDBD"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </Border>
                    </VerticalStackLayout>
                    
                    <!-- Cancel button at bottom -->
                    <Border Grid.Row="2"
                            Stroke="#E0E0E0"
                            StrokeThickness="1"
                            BackgroundColor="#F5F5F5"
                            Margin="20,0,20,16"
                            Padding="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8"/>
                        </Border.StrokeShape>
                        <Button Text="Cancel"
                                Command="{Binding CloseOverlayCommand}"
                                BackgroundColor="Transparent"
                                TextColor="#757575"
                                FontSize="16"
                                FontAttributes="Bold"
                                Padding="12"/>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
